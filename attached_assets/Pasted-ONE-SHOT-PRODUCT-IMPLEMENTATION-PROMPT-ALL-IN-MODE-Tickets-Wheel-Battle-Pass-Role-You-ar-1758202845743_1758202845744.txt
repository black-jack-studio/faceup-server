ONE-SHOT PRODUCT & IMPLEMENTATION PROMPT â€” â€œALL-INâ€ MODE (Tickets, Wheel, Battle Pass)

Role: You are the lead full-stack engineer. Implement a new game mode â€œAll-inâ€ and all supporting systems. If files already exist, replace them. Keep palette strictly black/gray/white (no brand colors).

0) Feature Overview
	â€¢	New mode card: All-in â€” description:
â€œGo all or nothing. Bet everything you have: triple on win, lose it all on defeat. Tickets required.â€
Display on the card: ticket icon + user ticket count.
	â€¢	Entry requires Tickets (new currency). Tickets can be won via:
	1.	Wheel of Fortune (adjust reward table to include Tickets),
	2.	Battle Pass milestones (both Free and Premium tracks).
Rewards grant 1, 3, or 5 tickets.
	â€¢	Game rule: Bet must equal 100% of current coins.
If WIN â†’ coins *= 3.
If LOSE â†’ coins = 0, but refund 5% of pre-bet coins into bonusCoins (non-withdrawable, playable).
Win probability is intentionally hard (configurable server-side).
	â€¢	Flow: Tap â€œAll-inâ€ â†’ go to Bet page (same layout as our new sober slider UI), but only â€œMAXâ€ is available. User must select MAX; otherwise play is disabled.

â¸»

1) Data Model (create/extend)

type User = {
  id: string;
  coins: number;        // main spendable coins
  bonusCoins: number;   // rebate storage, playable only
  allInLoseStreak: number;
  cooldownUntil?: string | null; // optional future use
  level: number;        // for Battle Pass progression
};

type Ticket = {          // Track aggregate count per user (or keep as counter)
  userId: string;
  count: number;        // total available tickets
  updatedAt: string;
};

type AllInRun = {
  id: string;
  userId: string;
  preBalance: number;   // coins before the bet
  betAmount: number;    // equals preBalance
  result: 'WIN' | 'LOSE';
  multiplier: number;   // 3 on win, 0 on lose
  payout: number;       // net coins added on win
  rebate: number;       // 5% rebate to bonusCoins on loss
  createdAt: string;
};

type Config = {
  allInWinProbability: number; // e.g. 0.28 (HARD). Keep < 0.35 to stay profitable.
  lossRebatePct: number;       // 0.05
  wheelTicketWeights: {one: number; three: number; five: number}; // e.g. {one: 6, three: 3, five: 1}
  passTicketAmounts: number[]; // milestones e.g. [1,3,5]
};


â¸»

2) Backend â€” Endpoints & Logic (Node/Express or adapt to stack)

Auth required for all. Server is authoritative. Use transactions/locks.
	â€¢	GET /allin/status â†’
{ coins, bonusCoins, tickets, winProb, lossRebatePct }
	â€¢	POST /allin/start
Flow:
	1.	Load user + ticket row (FOR UPDATE). Ensure tickets.count > 0 and user.coins > 0.
	2.	betAmount = user.coins (100% max).
	3.	Consume 1 ticket (tickets.count -= 1).
	4.	Draw outcome with hard probability:

const win = Math.random() < config.allInWinProbability; // e.g. 0.28


	5.	If win:
	â€¢	multiplier = 3
	â€¢	payout = betAmount * 2 (since coins already include bet; final coins = pre + payout = 3x)
	â€¢	user.coins += payout
	â€¢	user.allInLoseStreak = 0
	6.	If lose:
	â€¢	user.coins = 0
	â€¢	rebate = Math.floor(betAmount * config.lossRebatePct) (5%)
	â€¢	user.bonusCoins += rebate
	â€¢	user.allInLoseStreak += 1
	7.	Insert AllInRun audit; commit transaction.
	8.	Return { result, multiplier, payout, rebate, coins: user.coins, bonusCoins: user.bonusCoins, tickets: tickets.count }

	â€¢	Wheel integration changes (POST /wheel/spin):
	â€¢	Update reward table to include Tickets with 3 rarity bands:
	â€¢	1 Ticket (most common of ticket drops),
	â€¢	3 Tickets,
	â€¢	5 Tickets (rare).
	â€¢	Rebalance by replacing some coin/gem outcomes with tickets (do not increase total EV).
	â€¢	When tickets drop, increment Ticket.count accordingly.
	â€¢	Battle Pass integration:
	â€¢	Update pass milestone rewards (both Free & Premium tracks) to include tickets at multiple tiers using Config.passTicketAmounts [1,3,5].
	â€¢	On claim: Ticket.count += rewardTickets.

â¸»

3) Frontend â€” Mode Card & Bet Page

Mode Card â€œAll-inâ€
	â€¢	Card title: All-in
	â€¢	Subtitle (short): â€œBet it all. Triple or nothing. Tickets required.â€
	â€¢	Right side badge: ğŸŸï¸ x{userTickets} (live count).
	â€¢	Tap â†’ navigate to Bet screen (below).

Bet Page (reuse our sober Apple-Wallet style)
	â€¢	Top card (rounded bottom, soft shadow) showing:
	â€¢	Balance (small, gray),
	â€¢	Label YOUR BET,
	â€¢	Big amount (bind to slider value).
	â€¢	Slider: same visual as our mockup (black/gray/white).
	â€¢	BUT: Only MAX is allowed.
	â€¢	UI still shows slider + only one pill: â€œMAXâ€ (selected).
	â€¢	Disable Confirm until t === 1.0.
	â€¢	When t < 1, show hint: â€œAll-in mode requires betting 100% of your coins.â€
	â€¢	CTA: PLAY ALL-IN (white button).
	â€¢	On press: call /allin/start, then show result screen (win confetti or loss with â€œ5% Safe Return appliedâ€).

Edge cases UI
	â€¢	If tickets === 0 â†’ CTA becomes GET TICKETS, route to shop/wheel/pass screens.
	â€¢	If coins === 0 â†’ show No coins. Earn or buy coins to play. Disable CTA.
	â€¢	Show Tickets: xN under CTA for clarity.

â¸»

4) Wheel & Pass Reward Tables (rebalance)
	â€¢	Wheel: inject ticket outcomes; reduce coin/gem probabilities proportionally. Example weights:
	â€¢	Coins outcomes: reduce by 10â€“15% of total mass,
	â€¢	Gems outcomes: reduce slightly,
	â€¢	Tickets outcomes (total new mass ~10â€“15%):
	â€¢	1 Ticket: weight 6
	â€¢	3 Tickets: weight 3
	â€¢	5 Tickets: weight 1
	â€¢	Pass: place ticket rewards at milestones (both tracks). Example:
	â€¢	Free track: levels 3 (Ã—1), 10 (Ã—3), 18 (Ã—5)
	â€¢	Premium track: levels 2 (Ã—1), 7 (Ã—3), 15 (Ã—5)
	â€¢	Ensure UI shows a ticket icon and counts on claim screens.

â¸»

5) Config & Profitability Guardrails
	â€¢	In Config, set:
	â€¢	allInWinProbability = 0.25â€“0.30 (HARD)
	â€¢	lossRebatePct = 0.05
	â€¢	Keep EV â‰¤ 1 to remain profitable:
EV â‰ˆ p*3 + (1âˆ’p)*0.05 on principal, with p â‰¤ 0.30 gives EV < 1.
	â€¢	Add admin hook to tweak allInWinProbability without redeploy.

â¸»

6) Accessibility, Haptics, & Polish
	â€¢	Slider and CTA hit-areas â‰¥ 44pt.
	â€¢	Haptics: light success on win; warning on loss; selection on MAX.
	â€¢	Animations: thumb scale on drag; number tween (120â€“180ms).
	â€¢	Palette tokens (CSS/StyleSheet):
	â€¢	bg:#0F1012, card:#1C1D21â†’#24262B, barBase:#2B2D32, barFill:#E5E7EBâ†’#FFFFFF, pillBg:#2A2B30, pillBorder:#5A5C63, ctaBg:#FFFFFF, ctaText:#15161A.

â¸»

7) Acceptance Tests (must pass)
	â€¢	With 10,000 coins and 2 tickets: Bet page shows MAX only; Confirm disabled until MAX; play consumes 1 ticket.
	â€¢	Wheel can drop 1/3/5 tickets; Ticket.count increments accordingly.
	â€¢	Pass milestones grant tickets on claim (free & premium).
	â€¢	/allin/start rejects when tickets==0 or coins==0.
	â€¢	Loss: coinsâ†’0, bonusCoins += 5% prebalance.
	â€¢	Win: final coins = 3Ã— prebalance.
	â€¢	Probability adjustable via Config; default hard setting applied.
	â€¢	Mode card displays current ticket count.

â¸»

8) Deliverables
	â€¢	Backend: models/migrations for Ticket, AllInRun, Config; endpoints /allin/status, /allin/start; wheel/pass reward updates.
	â€¢	Frontend:
	â€¢	Mode card All-in (with ticket count badge),
	â€¢	Bet page (sober slider UI, MAX-only, confirm gating),
	â€¢	Result screen (win/lose),
	â€¢	Shop/Wheel/Pass links to earn tickets.
	â€¢	Tests for math, probabilities, reward granting, and endpoint contracts.

Implement now for the detected stack (React Native / Flutter / Web React). Replace legacy bet flows for this mode only; do not affect other modes.

